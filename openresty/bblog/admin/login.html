<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title>偶尔有点困-后台登录</title>
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="bookmark" href="/favicon.ico" />
		<link rel="stylesheet" href="../plugins/layui/css/layui.css" />
		<link rel="stylesheet" href="../css/admin/login/login.css" />
		<!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
		<!--[if lt IE 8]>
		<script type="text/javascript" src="plugins/ace/js/buttons.html5.min.js" ></script>
		<script type="text/javascript" src="plugins/ace/js/respond.min.js"></script>
		<![endif]-->
	</head>

	<body>
		<div class="layui-container">
			<div class="layadmin-user-login-main center">
				<form id="login" class="layadmin-user-login-box layadmin-user-login-body layui-form">
					<div class="layui-form-item">
						<div class="logo">
							<img src="https://spring.io/img/homepage/icon-spring-cloud-data-flow.svg" />
						</div>
						<h3 class="title">欢迎来到纯真年代后台管理系统</h3>
					</div>
					<div class="layui-form-item">
						<input name="username" lay-verify="required" placeholder="默认账号guest" class="my-layui-input" type="text">
					</div>
					<div class="layui-form-item">
						<input name="password" lay-verify="required|password" placeholder="默认密码guest" class="my-layui-input" type="password">
					</div>
					<div class="layui-form-item">
						<div class="layui-row">
							<div class="layui-col-xs7">
								<input type="hidden" name="code" />
								<input type="text" name="codeStr" id="LAY-user-login-vercode" lay-verify="required" placeholder="图形验证码" class="my-layui-input">
							</div>
							<div class="layui-col-xs5">
								<div style="margin-left: 10px;">
									<img id="codeImg" src="https://www.oschina.net/action/user/captcha" class="layadmin-user-login-codeimg" id="LAY-user-get-vercode">
								</div>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<button class="my-layui-btn" lay-submit lay-filter="LAY-user-login-submit">Login</button>
					</div>
				</form>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../plugins/layui/layui.js"></script>
	<script type="text/javascript">
		layui.config({
			base: '../js/admin/' //静态资源所在路径
		}).extend({
			common: '/common' //公共模块
		}).use(['common'], function() {
			var common = layui.common,
				layer = common.layer,
				form = common.form,
				$ = common.$;
			var login = {
				init: function() {
					form.render();
					login.initData();
					login.initSubmit();
					login.initFormCheck();
					login.initVerifyCode();
					login.initSubmit();
				},
				initData: function() {

				},
				bindEvent: function() {
					$("#codeImg").click(function() {
						login.initVerifyCode();
					});
				},
				initSubmit: function() {
					//提交
					form.on('submit(LAY-user-login-submit)', function(data) {
						var user_data = JSON.stringify(data.field);
						$.ajax({
							url: common.IP + '/api/blog-oauth2/oauth2/login',
							contentType: "application/x-www-form-urlencoded",
							headers: {
								'Authorization': ''
							},
							data: $('#login').serialize(),
							success: function(result, status, xhr) {
								layer.closeAll('loading');
								localStorage.setItem("access_token", result.access_token)
								localStorage.setItem("token_type", result.token_type)
								localStorage.setItem("refresh_token", result.refresh_token)
								localStorage.setItem("expires_in", result.expires_in)
								localStorage.setItem("scope", result.scope)
								layer.msg("登录成功", {
									icon: 1,
									time: 1000
								}, function() {
									parent.window.location.href = 'index.html'
								});
							},
							error: function(xhr, textStatus, errorThrown) {
								login.initVerifyCode();
								common.ajaxError(xhr, textStatus, errorThrown);
							}
						});
						return false;
					});
				},
				initFormCheck: function() {
					form.verify({
						password: [
							/^[\S]{5,16}$/, '密码必须5到16位，且不能出现空格'
						]
					});
				},
				initVerifyCode: function() {
					login.checkAccessToken();
					$.ajax({
						type: 'GET',
						async: false,
						url: common.IP + '/api/blog-oauth2/oauth2/verCode?histCode=' + $("input[name='code']").val(),
						success: function(data) {
							layer.closeAll('loading');
							$("input[name='code']").val(data.code);
							$("#codeImg").attr('src', data.codeStr);
						}
					});
				},
				checkAccessToken: function() {
					var access_token = localStorage.getItem("access_token");
					if(access_token != null && access_token.trim().length != 0) {
						$.ajax({
							type: 'POST',
							headers: {
								'Authorization': localStorage.getItem("access_token") == null ? "" : "Bearer " + localStorage.getItem("access_token")
							},
							async: false,
							url: common.IP + '/api/blog-oauth2/currentUser',
							success: function(data) {
								parent.window.location.href = 'index.html';
							},
							error: function(xhr, textStatus, errorThrown) {
								if(xhr.status == 401) {
									localStorage.removeItem("access_token");
								}
							}
						});
					}
				}
			};
			$(function() {
				login.init();
			});
		});
	</script>
	<script>
	</script>

</html>